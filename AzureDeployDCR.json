{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "metadata": {
        "title": "Data Collection Rule for CrowdStrike Alerts",
        "description": "Creates a Data Collection Rule (DCR) for ingesting CrowdStrike Falcon alerts data into the CrowdStrike_Alerts_CL table.",
        "prerequisites": [
            "The CrowdStrike_Alerts_CL custom table must already exist in the Log Analytics workspace",
            "A Data Collection Endpoint (DCE) must already be deployed"
        ],
        "lastUpdateTime": "2025-01-13T00:00:00Z",
        "support": {
            "tier": "partner"
        },
        "author": {
            "name": "Accelerynt"
        }
    },
    "parameters": {
        "DataCollectionRuleName": {
            "type": "string",
            "defaultValue": "dcr-crowdstrike-alerts",
            "metadata": {
                "description": "Name for the Data Collection Rule"
            }
        },
        "Location": {
            "type": "string",
            "metadata": {
                "description": "Azure region for the DCR deployment"
            }
        },
        "WorkspaceResourceId": {
            "type": "string",
            "metadata": {
                "description": "Full resource ID of the Log Analytics workspace (e.g., /subscriptions/{sub}/resourceGroups/{rg}/providers/Microsoft.OperationalInsights/workspaces/{name})"
            }
        },
        "DataCollectionEndpointResourceId": {
            "type": "string",
            "metadata": {
                "description": "Full resource ID of the Data Collection Endpoint (e.g., /subscriptions/{sub}/resourceGroups/{rg}/providers/Microsoft.Insights/dataCollectionEndpoints/{name})"
            }
        }
    },
    "resources": [
        {
            "type": "Microsoft.Insights/dataCollectionRules",
            "apiVersion": "2022-06-01",
            "name": "[parameters('DataCollectionRuleName')]",
            "location": "[parameters('Location')]",
            "properties": {
                "dataCollectionEndpointId": "[parameters('DataCollectionEndpointResourceId')]",
                "streamDeclarations": {
                    "Custom-CrowdStrike_Alerts_CL": {
                        "columns": [
                            { "name": "TimeGenerated", "type": "datetime" },
                            { "name": "Severity", "type": "string" },
                            { "name": "adversary_ids_s", "type": "string" },
                            { "name": "agent_id_g", "type": "string" },
                            { "name": "agent_scan_id_g", "type": "string" },
                            { "name": "aggregate_id_s", "type": "string" },
                            { "name": "alleged_filetype_s", "type": "string" },
                            { "name": "assigned_to_name_s", "type": "string" },
                            { "name": "assigned_to_uid_s", "type": "string" },
                            { "name": "assigned_to_uuid_g", "type": "string" },
                            { "name": "associated_files_s", "type": "string" },
                            { "name": "author_s", "type": "string" },
                            { "name": "child_process_ids_s", "type": "string" },
                            { "name": "cid_g", "type": "string" },
                            { "name": "cloud_indicator_s", "type": "string" },
                            { "name": "cmdline_s", "type": "string" },
                            { "name": "command_line_s", "type": "string" },
                            { "name": "comment_s", "type": "string" },
                            { "name": "comments_s", "type": "string" },
                            { "name": "composite_id_s", "type": "string" },
                            { "name": "confidence_d", "type": "real" },
                            { "name": "container_id_s", "type": "string" },
                            { "name": "context_timestamp_t", "type": "datetime" },
                            { "name": "control_graph_id_s", "type": "string" },
                            { "name": "crawled_timestamp_t", "type": "datetime" },
                            { "name": "created_timestamp_t", "type": "datetime" },
                            { "name": "data_domains_s", "type": "string" },
                            { "name": "description_s", "type": "string" },
                            { "name": "detection_context_file_system_operation_type_d", "type": "real" },
                            { "name": "detection_context_fs_operation_classification_d", "type": "real" },
                            { "name": "detection_context_reg_object_name_s", "type": "string" },
                            { "name": "detection_context_reg_operation_type_d", "type": "real" },
                            { "name": "detection_context_reg_string_value_s", "type": "string" },
                            { "name": "detection_context_reg_type_d", "type": "real" },
                            { "name": "detection_context_reg_value_name_s", "type": "string" },
                            { "name": "detection_context_target_file_name_s", "type": "string" },
                            { "name": "device_agent_load_flags_s", "type": "string" },
                            { "name": "device_agent_local_time_t", "type": "datetime" },
                            { "name": "device_agent_version_s", "type": "string" },
                            { "name": "device_bios_manufacturer_s", "type": "string" },
                            { "name": "device_bios_version_s", "type": "string" },
                            { "name": "device_cid_g", "type": "string" },
                            { "name": "device_config_id_base_s", "type": "string" },
                            { "name": "device_config_id_build_s", "type": "string" },
                            { "name": "device_config_id_platform_s", "type": "string" },
                            { "name": "device_device_id_g", "type": "string" },
                            { "name": "device_external_ip_s", "type": "string" },
                            { "name": "device_external_ipv6_s", "type": "string" },
                            { "name": "device_first_seen_t", "type": "datetime" },
                            { "name": "device_groups_s", "type": "string" },
                            { "name": "device_hostinfo_active_directory_dn_display_s", "type": "string" },
                            { "name": "device_hostinfo_domain_s", "type": "string" },
                            { "name": "device_hostname_s", "type": "string" },
                            { "name": "device_instance_id_g", "type": "string" },
                            { "name": "device_last_seen_t", "type": "datetime" },
                            { "name": "device_local_ip_s", "type": "string" },
                            { "name": "device_mac_address_s", "type": "string" },
                            { "name": "device_machine_domain_s", "type": "string" },
                            { "name": "device_major_version_s", "type": "string" },
                            { "name": "device_minor_version_s", "type": "string" },
                            { "name": "device_modified_timestamp_t", "type": "datetime" },
                            { "name": "device_os_version_s", "type": "string" },
                            { "name": "device_ou_s", "type": "string" },
                            { "name": "device_platform_id_s", "type": "string" },
                            { "name": "device_platform_name_s", "type": "string" },
                            { "name": "device_product_type_desc_s", "type": "string" },
                            { "name": "device_product_type_s", "type": "string" },
                            { "name": "device_service_provider_account_id_g", "type": "string" },
                            { "name": "device_service_provider_s", "type": "string" },
                            { "name": "device_site_name_s", "type": "string" },
                            { "name": "device_status_s", "type": "string" },
                            { "name": "device_system_manufacturer_s", "type": "string" },
                            { "name": "device_system_product_name_s", "type": "string" },
                            { "name": "device_tags_s", "type": "string" },
                            { "name": "display_name_s", "type": "string" },
                            { "name": "dns_requests_s", "type": "string" },
                            { "name": "email_sent_b", "type": "boolean" },
                            { "name": "end_time_epoch_d", "type": "real" },
                            { "name": "end_time_t", "type": "datetime" },
                            { "name": "entities_agent_ids_s", "type": "string" },
                            { "name": "entities_agent_ids_source_s", "type": "string" },
                            { "name": "entities_domain_s", "type": "string" },
                            { "name": "entities_file_name_s", "type": "string" },
                            { "name": "entities_image_file_name_s", "type": "string" },
                            { "name": "entities_ipv4_s", "type": "string" },
                            { "name": "entities_process_s", "type": "string" },
                            { "name": "entities_sha256_s", "type": "string" },
                            { "name": "entities_user_sid_s", "type": "string" },
                            { "name": "entities_user_sid_source_s", "type": "string" },
                            { "name": "entities_username_s", "type": "string" },
                            { "name": "entities_username_source_s", "type": "string" },
                            { "name": "entity_values_agent_ids_s", "type": "string" },
                            { "name": "entity_values_domain_names_s", "type": "string" },
                            { "name": "entity_values_ipv4s_s", "type": "string" },
                            { "name": "entity_values_sha256s_s", "type": "string" },
                            { "name": "entity_values_user_sids_s", "type": "string" },
                            { "name": "entity_values_users_s", "type": "string" },
                            { "name": "event_correlation_id_g", "type": "string" },
                            { "name": "event_id_g", "type": "string" },
                            { "name": "executables_written_s", "type": "string" },
                            { "name": "external_b", "type": "boolean" },
                            { "name": "falcon_host_link_s", "type": "string" },
                            { "name": "file_writes_s", "type": "string" },
                            { "name": "filename_s", "type": "string" },
                            { "name": "filepath_s", "type": "string" },
                            { "name": "files_accessed_s", "type": "string" },
                            { "name": "files_written_s", "type": "string" },
                            { "name": "global_prevalence_s", "type": "string" },
                            { "name": "grandparent_details_cmdline_s", "type": "string" },
                            { "name": "grandparent_details_filename_s", "type": "string" },
                            { "name": "grandparent_details_filepath_s", "type": "string" },
                            { "name": "grandparent_details_local_process_id_s", "type": "string" },
                            { "name": "grandparent_details_md5_g", "type": "string" },
                            { "name": "grandparent_details_process_graph_id_s", "type": "string" },
                            { "name": "grandparent_details_process_id_s", "type": "string" },
                            { "name": "grandparent_details_sha256_s", "type": "string" },
                            { "name": "grandparent_details_timestamp_t", "type": "datetime" },
                            { "name": "grandparent_details_user_graph_id_s", "type": "string" },
                            { "name": "grandparent_details_user_id_s", "type": "string" },
                            { "name": "grandparent_details_user_name_s", "type": "string" },
                            { "name": "has_adversary_b", "type": "boolean" },
                            { "name": "host_name_s", "type": "string" },
                            { "name": "host_names_s", "type": "string" },
                            { "name": "host_url_s", "type": "string" },
                            { "name": "id_s", "type": "string" },
                            { "name": "incident_created_t", "type": "datetime" },
                            { "name": "incident_created_time_t", "type": "datetime" },
                            { "name": "incident_end_t", "type": "datetime" },
                            { "name": "incident_end_time_t", "type": "datetime" },
                            { "name": "incident_highest_score_s", "type": "string" },
                            { "name": "incident_host_ids_s", "type": "string" },
                            { "name": "incident_id_s", "type": "string" },
                            { "name": "incident_score_s", "type": "string" },
                            { "name": "incident_start_t", "type": "datetime" },
                            { "name": "incident_start_time_t", "type": "datetime" },
                            { "name": "incident_state_s", "type": "string" },
                            { "name": "incident_type_s", "type": "string" },
                            { "name": "incident_version_d", "type": "real" },
                            { "name": "indicator_id_s", "type": "string" },
                            { "name": "ioc_context_s", "type": "string" },
                            { "name": "ioc_description_s", "type": "string" },
                            { "name": "ioc_source_s", "type": "string" },
                            { "name": "ioc_type_s", "type": "string" },
                            { "name": "ioc_value_s", "type": "string" },
                            { "name": "is_closed_b", "type": "boolean" },
                            { "name": "lead_id_s", "type": "string" },
                            { "name": "lead_type_s", "type": "string" },
                            { "name": "local_prevalence_s", "type": "string" },
                            { "name": "local_process_id_s", "type": "string" },
                            { "name": "logon_domain_s", "type": "string" },
                            { "name": "md5_g", "type": "string" },
                            { "name": "mitre_attack_s", "type": "string" },
                            { "name": "name_s", "type": "string" },
                            { "name": "network_accesses_s", "type": "string" },
                            { "name": "no_signal_b", "type": "boolean" },
                            { "name": "objective_s", "type": "string" },
                            { "name": "os_name_s", "type": "string" },
                            { "name": "overwatch_note_s", "type": "string" },
                            { "name": "parent_details_cmdline_s", "type": "string" },
                            { "name": "parent_details_filename_s", "type": "string" },
                            { "name": "parent_details_filepath_s", "type": "string" },
                            { "name": "parent_details_local_process_id_s", "type": "string" },
                            { "name": "parent_details_md5_g", "type": "string" },
                            { "name": "parent_details_process_graph_id_s", "type": "string" },
                            { "name": "parent_details_process_id_s", "type": "string" },
                            { "name": "parent_details_sha256_s", "type": "string" },
                            { "name": "parent_details_timestamp_t", "type": "datetime" },
                            { "name": "parent_details_user_graph_id_s", "type": "string" },
                            { "name": "parent_details_user_id_s", "type": "string" },
                            { "name": "parent_details_user_name_s", "type": "string" },
                            { "name": "parent_process_id_s", "type": "string" },
                            { "name": "pattern_disposition_d", "type": "real" },
                            { "name": "pattern_disposition_description_s", "type": "string" },
                            { "name": "pattern_disp_details_blocking_unsupported_or_disabled_b", "type": "boolean" },
                            { "name": "pattern_disposition_details_bootup_safeguard_enabled_b", "type": "boolean" },
                            { "name": "pattern_disposition_details_containment_file_system_b", "type": "boolean" },
                            { "name": "pattern_disposition_details_critical_process_disabled_b", "type": "boolean" },
                            { "name": "pattern_disposition_details_detect_b", "type": "boolean" },
                            { "name": "pattern_disposition_details_fs_operation_blocked_b", "type": "boolean" },
                            { "name": "pattern_disposition_details_handle_operation_downgraded_b", "type": "boolean" },
                            { "name": "pattern_disposition_details_inddet_mask_b", "type": "boolean" },
                            { "name": "pattern_disposition_details_indicator_b", "type": "boolean" },
                            { "name": "pattern_disposition_details_kill_action_failed_b", "type": "boolean" },
                            { "name": "pattern_disposition_details_kill_parent_b", "type": "boolean" },
                            { "name": "pattern_disposition_details_kill_process_b", "type": "boolean" },
                            { "name": "pattern_disposition_details_kill_subprocess_b", "type": "boolean" },
                            { "name": "pattern_disposition_details_mfa_required_b", "type": "boolean" },
                            { "name": "pattern_disposition_details_operation_blocked_b", "type": "boolean" },
                            { "name": "pattern_disposition_details_policy_disabled_b", "type": "boolean" },
                            { "name": "pattern_disp_details_prevention_provisioning_enabled_b", "type": "boolean" },
                            { "name": "pattern_disposition_details_process_blocked_b", "type": "boolean" },
                            { "name": "pattern_disposition_details_quarantine_file_b", "type": "boolean" },
                            { "name": "pattern_disposition_details_quarantine_machine_b", "type": "boolean" },
                            { "name": "pattern_disposition_details_registry_operation_blocked_b", "type": "boolean" },
                            { "name": "pattern_disp_details_response_action_already_applied_b", "type": "boolean" },
                            { "name": "pattern_disposition_details_response_action_failed_b", "type": "boolean" },
                            { "name": "pattern_disposition_details_response_action_triggered_b", "type": "boolean" },
                            { "name": "pattern_disposition_details_rooting_b", "type": "boolean" },
                            { "name": "pattern_disposition_details_sensor_only_b", "type": "boolean" },
                            { "name": "pattern_disposition_details_suspend_parent_b", "type": "boolean" },
                            { "name": "pattern_disposition_details_suspend_process_b", "type": "boolean" },
                            { "name": "pattern_id_d", "type": "real" },
                            { "name": "platform_s", "type": "string" },
                            { "name": "poly_id_s", "type": "string" },
                            { "name": "priority_details_raw_value_d", "type": "real" },
                            { "name": "priority_explanation_s", "type": "string" },
                            { "name": "priority_value_d", "type": "real" },
                            { "name": "process_end_time_s", "type": "string" },
                            { "name": "process_id_s", "type": "string" },
                            { "name": "process_start_time_s", "type": "string" },
                            { "name": "product_s", "type": "string" },
                            { "name": "quarantined_b", "type": "boolean" },
                            { "name": "quarantined_files_s", "type": "string" },
                            { "name": "references_indicator_alert_ids_s", "type": "string" },
                            { "name": "references_indicator_detection_ids_s", "type": "string" },
                            { "name": "references_indicator_vertex_ids_s", "type": "string" },
                            { "name": "references_source_vertex_id_s", "type": "string" },
                            { "name": "references_source_vertex_type_s", "type": "string" },
                            { "name": "references_xdr_indicator_ids_s", "type": "string" },
                            { "name": "references_xdr_source_event_id_g", "type": "string" },
                            { "name": "referrer_url_s", "type": "string" },
                            { "name": "resolution_s", "type": "string" },
                            { "name": "scan_id_g", "type": "string" },
                            { "name": "scenario_s", "type": "string" },
                            { "name": "score_d", "type": "real" },
                            { "name": "seconds_to_resolved_d", "type": "real" },
                            { "name": "seconds_to_triaged_d", "type": "real" },
                            { "name": "severity_name_s", "type": "string" },
                            { "name": "sha1_s", "type": "string" },
                            { "name": "sha256_s", "type": "string" },
                            { "name": "show_in_ui_b", "type": "boolean" },
                            { "name": "signal_end_timestamp_t", "type": "datetime" },
                            { "name": "signal_start_timestamp_t", "type": "datetime" },
                            { "name": "signal_updated_timestamp_t", "type": "datetime" },
                            { "name": "source_account_name_s", "type": "string" },
                            { "name": "source_event_model_s", "type": "string" },
                            { "name": "source_hosts_s", "type": "string" },
                            { "name": "source_products_s", "type": "string" },
                            { "name": "source_vendors_s", "type": "string" },
                            { "name": "start_time_epoch_d", "type": "real" },
                            { "name": "start_time_t", "type": "datetime" },
                            { "name": "status_s", "type": "string" },
                            { "name": "tactic_id_s", "type": "string" },
                            { "name": "tactic_ids_s", "type": "string" },
                            { "name": "tactic_s", "type": "string" },
                            { "name": "tactics_s", "type": "string" },
                            { "name": "tags_s", "type": "string" },
                            { "name": "technique_id_s", "type": "string" },
                            { "name": "technique_ids_s", "type": "string" },
                            { "name": "technique_s", "type": "string" },
                            { "name": "techniques_s", "type": "string" },
                            { "name": "template_instance_id_s", "type": "string" },
                            { "name": "template_instance_version_s", "type": "string" },
                            { "name": "template_interface_id_d", "type": "real" },
                            { "name": "template_interface_name_s", "type": "string" },
                            { "name": "threatgraph_indicators_s", "type": "string" },
                            { "name": "timestamp_t", "type": "datetime" },
                            { "name": "tree_id_s", "type": "string" },
                            { "name": "tree_root_s", "type": "string" },
                            { "name": "triggering_process_graph_id_s", "type": "string" },
                            { "name": "type_s", "type": "string" },
                            { "name": "updated_timestamp_t", "type": "datetime" },
                            { "name": "user_id_s", "type": "string" },
                            { "name": "user_name_s", "type": "string" },
                            { "name": "user_principal_s", "type": "string" },
                            { "name": "xdr_detection_id_s", "type": "string" },
                            { "name": "xdr_pattern_id_d", "type": "real" },
                            { "name": "xdr_rule_id_d", "type": "real" },
                            { "name": "xdr_type_s", "type": "string" },
                            { "name": "image_file_name_s", "type": "string" },
                            { "name": "RawJson_s", "type": "string" }
                        ]
                    }
                },
                "destinations": {
                    "logAnalytics": [
                        {
                            "workspaceResourceId": "[parameters('WorkspaceResourceId')]",
                            "name": "la-workspace"
                        }
                    ]
                },
                "dataFlows": [
                    {
                        "streams": [
                            "Custom-CrowdStrike_Alerts_CL"
                        ],
                        "destinations": [
                            "la-workspace"
                        ],
                        "transformKql": "source",
                        "outputStream": "Custom-CrowdStrike_Alerts_CL"
                    }
                ],
                "description": "DCR for CrowdStrike Falcon Alerts data"
            }
        }
    ],
    "outputs": {
        "dataCollectionRuleName": {
            "type": "string",
            "value": "[parameters('DataCollectionRuleName')]"
        },
        "dataCollectionRuleId": {
            "type": "string",
            "value": "[resourceId('Microsoft.Insights/dataCollectionRules', parameters('DataCollectionRuleName'))]"
        },
        "immutableId": {
            "type": "string",
            "value": "[reference(resourceId('Microsoft.Insights/dataCollectionRules', parameters('DataCollectionRuleName'))).immutableId]"
        }
    }
}
